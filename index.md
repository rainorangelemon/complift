---
layout: default
name: "Improving Compositional Generation with Diffusion Models Using Lift Scores"
title:  "Improving Compositional Generation with Diffusion Models Using Lift Scores"
description: a compositional criteria for rejection and resampling of samples generated by diffusion models
image: "https://rainorangelemon.github.io/complift/data/accepted_vs_rejected.png"
date:   2020-05-21 15:38:11 -0800
usemathjax: true
---

<!-- Add viewport meta tag for mobile responsiveness -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Mobile-responsive styles for math equations -->
<style>
/* Mobile math equation responsiveness */
@media (max-width: 768px) {
  /* MathJax display equations */
  .MathJax_Display {
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    padding: 5px 0;
    -webkit-overflow-scrolling: touch;
  }

  /* MathJax inline equations */
  .MathJax {
    max-width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Reduce font size for math on mobile */
  .MathJax_Display .MathJax {
    font-size: 0.9em !important;
  }

  /* Tables containing math */
  .math-table {
    overflow-x: auto;
    display: block;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }

  .math-table table {
    min-width: 100%;
  }

  /* Equation containers */
  .equation-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px 0;
  }
}

@media (max-width: 480px) {
  /* Even smaller font size for very small screens */
  .MathJax_Display .MathJax {
    font-size: 0.8em !important;
  }

  .MathJax {
    font-size: 0.85em !important;
  }

  /* Reduce table font size */
  .math-table {
    font-size: 0.8em;
  }

  /* Add scroll hint for long equations */
  .MathJax_Display::after {
    content: "‚Üê scroll ‚Üí";
    display: block;
    text-align: center;
    font-size: 0.7em;
    color: #666;
    margin-top: 5px;
    opacity: 0.7;
  }
}

/* General responsive improvements for math content */
.math-table {
  margin: 20px auto;
  border-collapse: collapse;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
  width: auto;
  max-width: 100%;
}

.math-table th,
.math-table td {
  padding: 12px 15px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.math-table th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #2c3e50;
}

.math-table tr:hover {
  background-color: #f5f5f5;
}

/* Mobile table responsiveness */
@media (max-width: 768px) {
  .math-table {
    width: 100% !important;
    margin: 10px 0;
    font-size: 0.9em;
    border-radius: 6px;
  }

  /* Make table container full width on mobile */
  div[style*="display: table"] {
    display: block !important;
    width: 100% !important;
    margin: 10px 0 !important;
  }

  .math-table th,
  .math-table td {
    padding: 10px 8px;
    font-size: 1em;
  }

  /* Make the table container full width on mobile */
  .math-table th:first-child,
  .math-table td:first-child {
    padding-left: 12px;
  }

  .math-table th:last-child,
  .math-table td:last-child {
    padding-right: 12px;
  }
}

@media (max-width: 480px) {
  .math-table {
    width: 100% !important;
    margin: 8px 0;
    font-size: 0.85em;
    border-radius: 4px;
  }

  /* Ensure container takes full width on small mobile */
  div[style*="display: table"] {
    display: block !important;
    width: 100% !important;
    margin: 8px 0 !important;
    padding: 0 5px;
  }

  .math-table th,
  .math-table td {
    padding: 8px 6px;
    font-size: 1em;
    line-height: 1.3;
  }

  /* Adjust column widths for better mobile display */
  .math-table th:nth-child(1),
  .math-table td:nth-child(1) {
    width: 25%;
  }

  .math-table th:nth-child(2),
  .math-table td:nth-child(2) {
    width: 30%;
  }

  .math-table th:nth-child(3),
  .math-table td:nth-child(3) {
    width: 45%;
  }
}

/* Ensure MathJax equations don't break layout */
mjx-container {
  overflow-x: auto !important;
  overflow-y: hidden !important;
  max-width: 100% !important;
}

/* For MathJax v3 */
mjx-container[display="true"] {
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch !important;
  padding: 5px 0 !important;
}

@media (max-width: 768px) {
  mjx-container {
    font-size: 0.9em !important;
  }
}

@media (max-width: 480px) {
  mjx-container {
    font-size: 0.8em !important;
  }
}
</style>

Diffusion models have revolutionized generative modeling, particularly in producing high-quality images. Yet, when faced with complex prompts involving multiple objects or conditions, they often stumble: generated images might satisfy only part of a prompt or contain inconsistencies.

In our [ICML 2025 paper](https://arxiv.org/abs/2505.13740), we introduce **CompLift**‚Äîa lightweight, training-free rejection criterion using **lift scores**‚Äîto address this issue.

# Table of Contents:

1. [Sometimes, Compositional Prompts Break Diffusion Models](#-sometimes-compositional-prompts-break-diffusion-models)
3. [What is CompLift?](#-what-is-complift)
    1. [Lift Scores, Explained](#-lift-scores-explained)
    2. [Compositional Logic via Lift](#-compositional-logic-via-lift)
    3. [Efficient Implementation](#-efficient-implementation)
    4. [Connection to Classifier-Free Guidance](#-connection-to-classifier-free-guidance)
4. [Results](#-results)
5. [Lift in the Latent Space](#-lift-in-the-latent-space)
6. [Correlation between Lift Scores and CLIP Scores](#-correlation-between-lift-scores-and-clip-scores)
7. [Get Started](#-get-started)

## ü§î Sometimes, Compositional Prompts Break Diffusion Models

Compositional prompts require satisfying multiple conditions simultaneously. Some diffusion models, e.g., Stable Diffusion, trained on rich datasets tend to focus on the objects mentioned with an earlier order in the prompt. As a result, given a prompt like:

> "a black car and a white clock"

The model might tend to generate a black car, and ignore the white clock. See the example below - here we have 100 samples generated by [Stable Diffusion XL](https://arxiv.org/abs/2307.01952). The 62 <span style="color: #2196F3;">blue-bordered</span> samples indicate that they satisfy the constraint to include a white clock, while the 38 <span style="color: #FF9800;">orange-bordered</span> samples do not include a white clock.

<style>
.grid-container {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 5px;
  max-width: 800px;
  margin: 20px auto;
  position: relative;
}

.grid-item {
  aspect-ratio: 1;
  border: 2px solid #ddd;
  border-radius: 4px;
  transition: transform 0.1s ease;
  position: relative;
  background-size: cover;
  background-position: center;
  cursor: pointer;
}

{% assign labels = "0,1,0,0,1,0,0,1,0,1,1,1,1,1,1,1,1,0,0,0,1,0,1,1,0,0,0,1,1,1,0,1,1,0,1,1,1,0,0,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,0,0,1,1,1,1,1,1,1,1,0,0,0,1,0,0,1,1,1" | split: "," %}

{% for i in (0..99) %}
{% assign label = labels[i] %}
{% if label == "1" %}
.grid-item:nth-child({{ i | plus: 1 }}) {
  border-color: #2196F3;
}
{% else %}
.grid-item:nth-child({{ i | plus: 1 }}) {
  border-color: #FF9800;
}
{% endif %}
{% endfor %}

.grid-item:hover {
  transform: scale(4);
  z-index: 2;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border-radius: 8px;
  border-width: 3px;
}

/* Adjust transform origin based on position */
.grid-item:nth-child(10n) {
  transform-origin: left center;
}
.grid-item:nth-child(10n+1) {
  transform-origin: right center;
}
.grid-item:nth-child(-n+10) {
  transform-origin: center bottom;
}
.grid-item:nth-child(n+91) {
  transform-origin: center top;
}

/* Generate background-image rules for all 100 items */
{% for i in (0..99) %}
.grid-item:nth-child({{ i | plus: 1 }}) {
  background-image: url('{{ site.baseurl }}/images/{{ i }}.jpg');
}
{% endfor %}
</style>

<div class="grid-container">
  {% for i in (0..99) %}
    {% assign label = labels[i] %}
    <div class="grid-item" data-label="{{ label }}"></div>
  {% endfor %}
</div>

Some previous works, e.g., [Attend & Excite](https://arxiv.org/abs/2301.13826), hypothesize that this happens because the model is biased towards some parts of the prompt, while ignoring others.

Our goal is to design a **rejection criterion** that can detect whether a generated sample satisfies each component of a compositional prompt, and reject it if it does not.

## üöÄ What is CompLift?

**CompLift** is a plug-and-play resampling technique that checks if a generated sample truly satisfies a prompt‚Äî**without retraining or using any extra models**. It leverages a classic statistical idea: **lift scores**.

### üîç Lift Scores, Explained

Lift measures how much a condition $$c$$ influences the probability of generating a sample $$x$$. Formally:

$$
\begin{equation}
\text{lift}(x|c) = \log\frac{p(x|c)}{p(x)} \tag{1}
\label{eqn:lift}
\end{equation}
$$

In practice, we show that we can approximate Eq. \eqref{eqn:lift} using the internal denoising predictions of the diffusion model itself. Similar techniques can be found in [Diffusion Classifier](https://diffusion-classifier.github.io/).

<div class="equation-container">
$$
\begin{equation}
\text{lift}(x|c) \approx \mathbb{E}_{t,\epsilon}\{||\epsilon-\epsilon_\theta(x_t, \varnothing)||^2-||\epsilon-\epsilon_\theta(x_t, c)||^2\} \tag{2}
\label{eqn:lift-approx}
\end{equation}
$$
</div>

Note:
- $$\epsilon_\theta$$ is the diffusion model
- $$t$$ is randomly sampled diffusion steps
- $$\epsilon \sim \mathcal{N}(0, I)$$ is the randomly sampled noise
- $$x_t$$ is the sample at step $$t$$, which is a noisy version of $$x_0$$

Intuitively, Eq. \eqref{eqn:lift-approx} means:

> If a sample aligns with the condition, the model should be **better at denoising it** when given that condition.

This allows us to check conditions *after* generation, and reject samples that don't satisfy them. Note that this is **training-free** and **does not require any extra models**.

### üß† Compositional Logic via Lift

CompLift handles logical combinations of conditions:

- **AND (Product)**: Accept only if all subconditions have positive lift.
- **OR (Mixture)**: Accept if *any* subcondition has positive lift.
- **NOT (Negation)**: Reject if a subcondition is satisfied.

<div style="display: table; margin-left: auto; margin-right: auto;">
  <table class="math-table" style="margin: 0px auto; margin-left: auto; margin-right: auto;">
    <thead>
      <tr>
        <th>Type</th>
        <th>Algebra</th>
        <th>Acceptance Criterion</th>
      </tr>
    </thead>
    <tbody style="text-align: center; margin-left: auto; margin-right: auto;">
      <tr>
        <td>Product</td>
        <td>\(c_1 \wedge c_2\)</td>
        <td>\(\min_{i\in[1,2]}\text{lift}(x|c_i)> 0\)</td>
      </tr>
      <tr>
        <td>Mixture</td>
        <td>\(c_1 \vee c_2\)</td>
        <td>\(\max_{i\in[1,2]}\text{lift}(x|c_i)> 0\)</td>
      </tr>
      <tr>
        <td>Negation</td>
        <td>\(\neg c_1\)</td>
        <td>\(\text{lift}(x|c_1)\leq 0\)</td>
      </tr>
    </tbody>
  </table>
</div>

<p style="text-align: center; font-size: 0.9em;">
  <b>Table 1:</b> Examples of composition rules for multiple conditions.
</p>

This compositional approach lets us flexibly combine prompts into logical structures! We call this compositional criteria as **CompLift**. Here we show some examples in 2D synthetic tasks. Here, we use the [Composable Diffusion](https://arxiv.org/abs/2406.00003) as the baseline. `+ CompLift` means we use CompLift to reject the samples that do not satisfy the criteria among the Composable Diffusion samples.

<div style="margin: 20px 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="flex: 1; text-align: center;">
            <span style="line-height: 24px;">Component A</span>
        </div>
        <div style="flex: 0.2; text-align: center;"></div>
        <div style="flex: 1; text-align: center;">
            <span style="line-height: 24px;">Component B</span>
        </div>
        <div style="flex: 0.2; text-align: center;"></div>
        <div style="flex: 1; text-align: center;">
            <label style="display: inline-flex; align-items: center; gap: 2px;">
                <input type="checkbox" checked onclick="toggleVisibility('gt')" style="margin: 0;"> Ground Truth
            </label>
        </div>
        <div style="flex: 0.2; text-align: center;"></div>
        <div style="flex: 1; text-align: center;">
            <label style="display: inline-flex; align-items: center; gap: 2px;">
                <input type="checkbox" checked onclick="toggleVisibility('cd')" style="margin: 0;"> Composable Diffusion
            </label>
        </div>
        <div style="flex: 0.2; text-align: center;"></div>
        <div style="flex: 1; text-align: center;">
            <label style="display: inline-flex; align-items: center; gap: 2px;">
                <input type="checkbox" checked onclick="toggleVisibility('cl')" style="margin: 0;"> + CompLift
            </label>
        </div>
    </div>

    <h4 style="text-align: center; margin: 20px 0 10px;">Product Example</h4>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="flex: 1;">
            <img src="images/product_a3/sample_1_gt.png" alt="Sample 1" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">\(\times\)</span>
        </div>
        <div style="flex: 1;">
            <img src="images/product_a3/sample_2_gt.png" alt="Sample 2" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">=</span>
        </div>
        <div style="flex: 1;" id="gt-product">
            <img src="images/product_a3/sample_composed_gt.png" alt="Ground Truth" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cd-product">
            <img src="images/product_a3/baseline_diffusion.png" alt="Baseline" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cl-product">
            <img src="images/product_a3/baseline_rejection.png" alt="With CompLift" style="width: 100%; max-width: 150px;">
        </div>
    </div>

    <h4 style="text-align: center; margin: 20px 0 10px;">Mixture Example</h4>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="flex: 1;">
            <img src="images/summation_a3/sample_1_gt.png" alt="Sample 1" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">\(+\)</span>
        </div>
        <div style="flex: 1;">
            <img src="images/summation_a3/sample_2_gt.png" alt="Sample 2" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">=</span>
        </div>
        <div style="flex: 1;" id="gt-sum">
            <img src="images/summation_a3/sample_composed_gt.png" alt="Ground Truth" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cd-sum">
            <img src="images/summation_a3/baseline_diffusion.png" alt="Baseline" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cl-sum">
            <img src="images/summation_a3/baseline_rejection.png" alt="With CompLift" style="width: 100%; max-width: 150px;">
        </div>
    </div>

    <h4 style="text-align: center; margin: 20px 0 10px;">Negation Example</h4>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="flex: 1;">
            <img src="images/negation_a3/sample_1_gt.png" alt="Sample 1" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">\(-\)</span>
        </div>
        <div style="flex: 1;">
            <img src="images/negation_a3/sample_2_gt.png" alt="Sample 2" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;">=</span>
        </div>
        <div style="flex: 1;" id="gt-neg">
            <img src="images/negation_a3/sample_composed_gt.png" alt="Ground Truth" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cd-neg">
            <img src="images/negation_a3/baseline_diffusion.png" alt="Baseline" style="width: 100%; max-width: 150px;">
        </div>
        <div style="flex: 0.2; text-align: center;">
            <span style="font-size: 24px; font-weight: bold;"> </span>
        </div>
        <div style="flex: 1;" id="cl-neg">
            <img src="images/negation_a3/baseline_rejection.png" alt="With CompLift" style="width: 100%; max-width: 150px;">
        </div>
    </div>
</div>

<script>
function toggleVisibility(id) {
    const element = document.getElementById(id + '-product');
    const elementSum = document.getElementById(id + '-sum');
    const elementNeg = document.getElementById(id + '-neg');

    if (element.style.visibility === 'hidden') {
        element.style.visibility = 'visible';
        elementSum.style.visibility = 'visible';
        elementNeg.style.visibility = 'visible';
    } else {
        element.style.visibility = 'hidden';
        elementSum.style.visibility = 'hidden';
        elementNeg.style.visibility = 'hidden';
    }
}
</script>

### ‚öôÔ∏è Efficient Implementation

[In our paper](https://arxiv.org/abs/2505.13740), we investigate several design choices for CompLift. A TL;DR version is:

1. Sharing sampled $$(\epsilon, t)$$ pairs between the estimation of $$p(x)$$ and $$p(x \\| c)$$ is most efficient.
2. Importance sampling on $$t$$ is required when the original diffusion model $$\epsilon_\theta$$ is trained with importance sampling.
3. We can reuse the calculation of $$\epsilon_\theta(x_t, c)$$, that are computed when $$x$$ is generated, to save compute when estimating $$\text{lift}$$.

### üìù Connection to Classifier-Free Guidance

One would notice that the above implementation is similar to the [classifier-free guidance technique (CFG)](https://arxiv.org/abs/2207.12598) - we have $$\epsilon_\theta(x_t, c)$$ and we compare it with $$\epsilon_\theta(x_t, \varnothing)$$. In the appendix of our paper, we show that they are dual to each other from the Lagrangian perspective.

CompLift solves the *primal problem* - the sampler tries to generate samples that satisfy the ground truth condition.

<div class="equation-container">
$$
\begin{aligned}
& x_0 \sim p_{\text{generator}}(x_0), \quad \text{s.t. } p(x_0 \mid c_i) > p(x_0), \quad \forall c_i, \\
\Leftrightarrow \quad & x_0 \sim p_{\text{generator}}(x_0), \quad \text{s.t. } \text{lift}(x_0 \mid c_i) > 0, \quad \forall c_i.
\end{aligned}
$$
</div>

CFG / Composable Diffusion solves the *dual problem* - the sampler tries to generate samples that are close to the ground truth condition and keeps a balance using the Lagrangian coefficient $$\lambda_i$$.

<div class="equation-container">
$$
\begin{aligned}
& \mathcal{L}(x_0, \lambda) = \log p_{\text{generator}}(x_0) + \sum_{c_i} \lambda_i \Bigl( \log p(x_0 \mid c_i) - \log p(x_0) \Bigr), \quad \lambda_i \geq 0, \\
\Rightarrow & \nabla_{x_t} \mathcal{L}(x_0, \lambda) \approx \epsilon_\theta(x_t, \varnothing) + \sum_{c_i} \lambda_i \Bigl( \epsilon_\theta(x_t, c_i) - \epsilon_\theta(x_t, \varnothing) \Bigr), \quad \lambda_i \geq 0.
\end{aligned}
$$
</div>

Note:
- CFG / Composable Diffusion often sets the Lagrangian coefficient $$\lambda_i$$ as a fixed weight value $$w$$.
- The choice of $$p_{\text{generator}}(x_0)$$ can vary. CompLift mainly uses $$p_{\text{generator}}(x_0)$$ as $$p_\theta(x_0, c_{\text{prompt}})$$, while CFG / Composable Diffusion often regards $$p_{\text{generator}}(x_0)$$ as $$p_\theta(x_0, \varnothing)$$.

## üß™ Results

We evaluate CompLift on:

- üé® 2D synthetic tasks
- üß± CLEVR object positioning
- üñº Text-to-image generation (SD 1.4/2.1/XL)

Across the board, CompLift significantly improves prompt alignment without harming quality. More details can be found in [our paper](https://arxiv.org/abs/2505.13740).

| Task           | Metric                | Baseline | +CompLift |
|:----------------:|:------------------------:|:----------:|:-----------:|
| 2D Synthetic Task    | Accuracy               | 45.0%    | **92.9%** |
| CLEVR Position (5 objects) | Accuracy  | 78.7%    | **90.3%** |
| SD 2.1         | CLIP Score | 0.342    | **0.352** |

Here we show some examples of the generated samples with Stable Diffusion XL. <span style="color: #2196F3;">Blue-bordered</span> images are <span style="color: #2196F3;"><strong>accepted</strong></span> by the CompLift, while <span style="color: #FF9800;">orange-bordered</span> images are <span style="color: #FF9800;"><strong>rejected</strong></span>.

<style>
.image-gallery {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    gap: 3px;
}

.gallery-group {
    margin: 0;
    width: 49%;
}

.gallery-group-lift-scores {
    width: 100%;
}

.image-row {
    display: flex;
    gap: 3px;
}

.gallery-image {
    width: 20%;
    object-fit: contain;
    position: relative;
    z-index: 1;
    pointer-events: none;  /* Disable hover by default */
}

.gallery-image.original,
.gallery-image.latent,
.gallery-image.heatmap1,
.gallery-image.heatmap2,
.gallery-image.heatmap3,
.gallery-image.accepted,
.gallery-image.rejected {
    pointer-events: auto;  /* Enable hover for these classes */
    transition: transform 0.2s ease;
}

/* Make hover work regardless of accepted/rejected state */
.gallery-image.original:hover,
.gallery-image.latent:hover,
.gallery-image.heatmap1:hover,
.gallery-image.heatmap2:hover,
.gallery-image.heatmap3:hover {
    transform: scale(2);
    z-index: 20;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.gallery-image.accepted:hover,
.gallery-image.rejected:hover {
    transform: scale(4);
    z-index: 20;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.gallery-image.accepted {
    border: 2px solid #ddd;
    border-color: #2196F3;
    border-radius: 4px;
    transform: scale(1);
    transition: transform 0.2s ease;
}

.gallery-image.rejected {
    border: 2px solid #ddd;
    border-color: #FF9800;
    border-radius: 4px;
    transform: scale(1);
    transition: transform 0.2s ease;
}

.gallery-caption {
    text-align: center;
    font-size: 0.9em;
    margin-top: 5px;
}

.highlight {
    color: #2196F3;
}

.gallery-image.hidden {
    visibility: hidden;
    opacity: 0;
}

.gallery-image:not(.hidden) {
    visibility: visible;
    opacity: 1;
}

.heatmap1, .heatmap2, .heatmap3 {
    transform: scale(1);
    transition: transform 0.2s ease;
}

.highlight-active {
    text-decoration: underline;
    font-weight: bold;
}

.heatmap-active {
    transform: scale(1.2);
    z-index: 10;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
</style>

<script>
function toggleColumn(columnClass) {
    const images = document.querySelectorAll(`.gallery-image.${columnClass}`);
    const isHidden = images[0].classList.contains('hidden');
    images.forEach(img => {
        if (isHidden) {
            img.classList.remove('hidden');
        } else {
            img.classList.add('hidden');
        }
    });
}
</script>

<div class="image-gallery">
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a turtle and a blue clock/0.jpg" class="gallery-image accepted" alt="Turtle and clock 1">
            <img src="sd_xl/a turtle and a blue clock/1.jpg" class="gallery-image accepted" alt="Turtle and clock 2">
            <img src="sd_xl/a turtle and a blue clock/2.jpg" class="gallery-image accepted" alt="Turtle and clock 3">
            <img src="sd_xl/a turtle and a blue clock/3.jpg" class="gallery-image rejected" alt="Turtle and clock 4">
            <img src="sd_xl/a turtle and a blue clock/4.jpg" class="gallery-image accepted" alt="Turtle and clock 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a turtle</span> and <span class="highlight">a blue clock</span></figcaption>
    </figure>
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a cat and a horse/0.jpg" class="gallery-image rejected" alt="Cat and horse 1">
            <img src="sd_xl/a cat and a horse/1.jpg" class="gallery-image accepted" alt="Cat and horse 2">
            <img src="sd_xl/a cat and a horse/2.jpg" class="gallery-image accepted" alt="Cat and horse 3">
            <img src="sd_xl/a cat and a horse/3.jpg" class="gallery-image rejected" alt="Cat and horse 4">
            <img src="sd_xl/a cat and a horse/4.jpg" class="gallery-image accepted" alt="Cat and horse 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a cat</span> and <span class="highlight">a horse</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a orange backpack and a purple car/0.jpg" class="gallery-image rejected" alt="Backpack and car 1">
            <img src="sd_xl/a orange backpack and a purple car/1.jpg" class="gallery-image rejected" alt="Backpack and car 2">
            <img src="sd_xl/a orange backpack and a purple car/2.jpg" class="gallery-image accepted" alt="Backpack and car 3">
            <img src="sd_xl/a orange backpack and a purple car/3.jpg" class="gallery-image rejected" alt="Backpack and car 4">
            <img src="sd_xl/a orange backpack and a purple car/4.jpg" class="gallery-image accepted" alt="Backpack and car 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">an orange backpack</span> and <span class="highlight">a purple car</span></figcaption>
    </figure>
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a frog with a bow/0.jpg" class="gallery-image rejected" alt="Frog with bow 1">
            <img src="sd_xl/a frog with a bow/1.jpg" class="gallery-image accepted" alt="Frog with bow 2">
            <img src="sd_xl/a frog with a bow/2.jpg" class="gallery-image accepted" alt="Frog with bow 3">
            <img src="sd_xl/a frog with a bow/3.jpg" class="gallery-image rejected" alt="Frog with bow 4">
            <img src="sd_xl/a frog with a bow/4.jpg" class="gallery-image accepted" alt="Frog with bow 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a frog</span> with <span class="highlight">a bow</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a elephant with a glasses/0.jpg" class="gallery-image rejected" alt="Elephant with glasses 1">
            <img src="sd_xl/a elephant with a glasses/1.jpg" class="gallery-image accepted" alt="Elephant with glasses 2">
            <img src="sd_xl/a elephant with a glasses/2.jpg" class="gallery-image accepted" alt="Elephant with glasses 3">
            <img src="sd_xl/a elephant with a glasses/3.jpg" class="gallery-image rejected" alt="Elephant with glasses 4">
            <img src="sd_xl/a elephant with a glasses/4.jpg" class="gallery-image accepted" alt="Elephant with glasses 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">an elephant</span> with <span class="highlight">glasses</span></figcaption>
    </figure>

    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a black crown and a red car/0.jpg" class="gallery-image rejected" alt="Crown and car 1">
            <img src="sd_xl/a black crown and a red car/1.jpg" class="gallery-image rejected" alt="Crown and car 2">
            <img src="sd_xl/a black crown and a red car/2.jpg" class="gallery-image accepted" alt="Crown and car 3">
            <img src="sd_xl/a black crown and a red car/3.jpg" class="gallery-image rejected" alt="Crown and car 4">
            <img src="sd_xl/a black crown and a red car/4.jpg" class="gallery-image rejected" alt="Crown and car 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a black crown</span> and <span class="highlight">a red car</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a white bow and a white car/0.jpg" class="gallery-image rejected" alt="Crown and car 1">
            <img src="sd_xl/a white bow and a white car/1.jpg" class="gallery-image rejected" alt="Crown and car 2">
            <img src="sd_xl/a white bow and a white car/2.jpg" class="gallery-image rejected" alt="Crown and car 3">
            <img src="sd_xl/a white bow and a white car/3.jpg" class="gallery-image accepted" alt="Crown and car 4">
            <img src="sd_xl/a white bow and a white car/4.jpg" class="gallery-image rejected" alt="Crown and car 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a white bow</span> and <span class="highlight">a white car</span></figcaption>
    </figure>

    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a lion with a bow/0.jpg" class="gallery-image rejected" alt="Lion and bow 1">
            <img src="sd_xl/a lion with a bow/1.jpg" class="gallery-image rejected" alt="Lion and bow 2">
            <img src="sd_xl/a lion with a bow/2.jpg" class="gallery-image rejected" alt="Lion and bow 3">
            <img src="sd_xl/a lion with a bow/3.jpg" class="gallery-image accepted" alt="Lion and bow 4">
            <img src="sd_xl/a lion with a bow/4.jpg" class="gallery-image accepted" alt="Lion and bow 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a lion</span> with <span class="highlight">a bow</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a red backpack and a yellow bowl/0.jpg" class="gallery-image accepted" alt="Red backpack and yellow bowl 1">
            <img src="sd_xl/a red backpack and a yellow bowl/1.jpg" class="gallery-image rejected" alt="Red backpack and yellow bowl 2">
            <img src="sd_xl/a red backpack and a yellow bowl/2.jpg" class="gallery-image rejected" alt="Red backpack and yellow bowl 3">
            <img src="sd_xl/a red backpack and a yellow bowl/3.jpg" class="gallery-image accepted" alt="Red backpack and yellow bowl 4">
            <img src="sd_xl/a red backpack and a yellow bowl/4.jpg" class="gallery-image accepted" alt="Red backpack and yellow bowl 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a red backpack</span> and <span class="highlight">a yellow bowl</span></figcaption>
    </figure>

    <figure class="gallery-group">
        <div class="image-row">
            <img src="sd_xl/a black car and a white clock/0.jpg" class="gallery-image rejected" alt="Black car and white clock 1">
            <img src="sd_xl/a black car and a white clock/1.jpg" class="gallery-image accepted" alt="Black car and white clock 2">
            <img src="sd_xl/a black car and a white clock/2.jpg" class="gallery-image rejected" alt="Black car and white clock 3">
            <img src="sd_xl/a black car and a white clock/3.jpg" class="gallery-image rejected" alt="Black car and white clock 4">
            <img src="sd_xl/a black car and a white clock/4.jpg" class="gallery-image accepted" alt="Black car and white clock 5">
        </div>
        <figcaption class="gallery-caption"><span class="highlight">a black car</span> and <span class="highlight">a white clock</span></figcaption>
    </figure>
</div>

In the examples above, CompLift shows great promise in improving prompt alignment. However, some limitations of CompLift can also be perceived:

- Since the ELBO estimation is an approximation, the lift score is not always accurate. This leads to some samples that are rejected but should be accepted, and vice versa (e.g., 1st image in "a frog with a bow" and 2nd image in "a lion with a bow").
- Too small objects tend to be rejected, e.g., the 2nd image in "a red backpack and a yellow bowl".
- Color-based conditions are not always identified effectively, e.g., the 5th image in "an orange backpack and a purple car".

## üî¨ Lift in the Latent Space

To handle fine-grained image prompts, we compute lift scores *per pixel* in the latent space, allowing us to detect whether each object is truly present. This even helps in understanding *which* part of the image aligns with each prompt component.

Here are some examples showing how lift scores help identify different objects in complex scenes:

<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
    <div style="flex: 1; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 2px;">
            <input type="checkbox" checked onclick="toggleColumn('original')" style="margin: 0;"> Original Image
        </label>
    </div>
    <div style="flex: 1; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 2px;">
            <input type="checkbox" checked onclick="toggleColumn('latent')" style="margin: 0;"> Latent Space
        </label>
    </div>
    <div style="flex: 1; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 2px;">
            <input type="checkbox" checked onclick="toggleColumn('heatmap1')" style="margin: 0;"> <span style="color: #F44336; background-color: rgba(244, 67, 54, 0.1);"> Component A</span>
        </label>
    </div>
    <div style="flex: 1; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 2px;">
            <input type="checkbox" checked onclick="toggleColumn('heatmap2')" style="margin: 0;"> <span style="color: #FF8F00; background-color: rgba(255, 193, 7, 0.1);"> Component B</span>
        </label>
    </div>
    <div style="flex: 1; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 2px;">
            <input type="checkbox" checked onclick="toggleColumn('heatmap3')" style="margin: 0;"> <span style="color: #4CAF50; background-color: rgba(76, 175, 80, 0.1);"> Component C</span>
        </label>
    </div>
</div>

<style>
.image-gallery {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    gap: 3px;
}

.gallery-group {
    margin: 0;
    width: 49%;
}

.gallery-group-lift-scores {
    width: 100%;
}

.image-row {
    display: flex;
    gap: 3px;
}

.gallery-image {
    width: 20%;
    object-fit: contain;
    position: relative;
    z-index: 1;
    pointer-events: none;  /* Disable hover by default */
}

.gallery-image.original,
.gallery-image.latent,
.gallery-image.heatmap1,
.gallery-image.heatmap2,
.gallery-image.heatmap3,
.gallery-image.accepted,
.gallery-image.rejected {
    pointer-events: auto;  /* Enable hover for these classes */
    transition: transform 0.2s ease;
}

/* Make hover work regardless of accepted/rejected state */
.gallery-image.original:hover,
.gallery-image.latent:hover,
.gallery-image.heatmap1:hover,
.gallery-image.heatmap2:hover,
.gallery-image.heatmap3:hover {
    transform: scale(2);
    z-index: 20;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.gallery-image.accepted:hover,
.gallery-image.rejected:hover {
    transform: scale(4);
    z-index: 20;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.gallery-image.accepted {
    border: 2px solid #ddd;
    border-color: #2196F3;
    border-radius: 4px;
    transform: scale(1);
    transition: transform 0.2s ease;
}

.gallery-image.rejected {
    border: 2px solid #ddd;
    border-color: #FF9800;
    border-radius: 4px;
    transform: scale(1);
    transition: transform 0.2s ease;
}

.gallery-caption {
    text-align: center;
    font-size: 0.9em;
    margin-top: 5px;
}

.gallery-image.hidden {
    visibility: hidden;
    opacity: 0;
}

.gallery-image:not(.hidden) {
    visibility: visible;
    opacity: 1;
}

.heatmap1, .heatmap2, .heatmap3 {
    transform: scale(1);
    transition: transform 0.2s ease;
}

.heatmap-active {
    transform: scale(2);
    z-index: 10;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
</style>

<script>
function toggleColumn(columnClass) {
    const images = document.querySelectorAll(`.gallery-image.${columnClass}`);
    const isHidden = images[0].classList.contains('hidden');
    images.forEach(img => {
        if (isHidden) {
            img.classList.remove('hidden');
        } else {
            img.classList.add('hidden');
        }
    });
}
</script>

<div class="image-gallery">
    <figure class="gallery-group gallery-group-lift-scores">
        <div class="image-row">
            <img src="images/3objects_lift/a steaming teacup beside an open book and a candle/original_image.png" class="gallery-image original" alt="Original: teacup, book, and candle">
            <img src="images/3objects_lift/a steaming teacup beside an open book and a candle/latents.png" class="gallery-image latent" alt="Latent representation">
            <img src="images/3objects_lift/a steaming teacup beside an open book and a candle/heatmap1.png" class="gallery-image heatmap1" alt="Lift score: teacup">
            <img src="images/3objects_lift/a steaming teacup beside an open book and a candle/heatmap2.png" class="gallery-image heatmap2" alt="Lift score: book">
            <img src="images/3objects_lift/a steaming teacup beside an open book and a candle/heatmap3.png" class="gallery-image heatmap3" alt="Lift score: candle">
        </div>
        <figcaption class="gallery-caption"><span style="color: #F44336; background-color: rgba(244, 67, 54, 0.1);">a steaming teacup</span> beside <span style="color: #FF8F00; background-color: rgba(255, 193, 7, 0.1);">an open book</span> and <span style="color: #4CAF50; background-color: rgba(76, 175, 80, 0.1);">a candle</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group gallery-group-lift-scores">
        <div class="image-row">
            <img src="images/3objects_lift/a glass bottle with a message drifting past starfish/original_image.png" class="gallery-image original" alt="Original: bottle, message, and starfish">
            <img src="images/3objects_lift/a glass bottle with a message drifting past starfish/latents.png" class="gallery-image latent" alt="Latent representation">
            <img src="images/3objects_lift/a glass bottle with a message drifting past starfish/heatmap1.png" class="gallery-image heatmap1" alt="Lift score: bottle">
            <img src="images/3objects_lift/a glass bottle with a message drifting past starfish/heatmap2.png" class="gallery-image heatmap2" alt="Lift score: message">
            <img src="images/3objects_lift/a glass bottle with a message drifting past starfish/heatmap3.png" class="gallery-image heatmap3" alt="Lift score: starfish">
        </div>
        <figcaption class="gallery-caption"><span style="color: #F44336; background-color: rgba(244, 67, 54, 0.1);">a glass bottle</span> with <span style="color: #FF8F00; background-color: rgba(255, 193, 7, 0.1);">a message</span> drifting past <span style="color: #4CAF50; background-color: rgba(76, 175, 80, 0.1);">starfish</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group gallery-group-lift-scores">
        <div class="image-row">
            <img src="images/3objects_lift/a wooden ladder reaching into a treehouse under stars/original_image.png" class="gallery-image original" alt="Original: ladder, treehouse, and stars">
            <img src="images/3objects_lift/a wooden ladder reaching into a treehouse under stars/latents.png" class="gallery-image latent" alt="Latent representation">
            <img src="images/3objects_lift/a wooden ladder reaching into a treehouse under stars/heatmap1.png" class="gallery-image heatmap1" alt="Lift score: ladder">
            <img src="images/3objects_lift/a wooden ladder reaching into a treehouse under stars/heatmap2.png" class="gallery-image heatmap2" alt="Lift score: treehouse">
            <img src="images/3objects_lift/a wooden ladder reaching into a treehouse under stars/heatmap3.png" class="gallery-image heatmap3" alt="Lift score: stars">
        </div>
        <figcaption class="gallery-caption"><span style="color: #F44336; background-color: rgba(244, 67, 54, 0.1);">a wooden ladder</span> reaching into <span style="color: #FF8F00; background-color: rgba(255, 193, 7, 0.1);">a treehouse</span> under <span style="color: #4CAF50; background-color: rgba(76, 175, 80, 0.1);">stars</span></figcaption>
    </figure>
</div>

<div class="image-gallery">
    <figure class="gallery-group gallery-group-lift-scores">
        <div class="image-row">
            <img src="images/3objects_lift/an old gramophone on a windowsill with falling autumn leaves/original_image.png" class="gallery-image original" alt="Original: gramophone, windowsill, and leaves">
            <img src="images/3objects_lift/an old gramophone on a windowsill with falling autumn leaves/latents.png" class="gallery-image latent" alt="Latent representation">
            <img src="images/3objects_lift/an old gramophone on a windowsill with falling autumn leaves/heatmap1.png" class="gallery-image heatmap1" alt="Lift score: gramophone">
            <img src="images/3objects_lift/an old gramophone on a windowsill with falling autumn leaves/heatmap2.png" class="gallery-image heatmap2" alt="Lift score: windowsill">
            <img src="images/3objects_lift/an old gramophone on a windowsill with falling autumn leaves/heatmap3.png" class="gallery-image heatmap3" alt="Lift score: leaves">
        </div>
        <figcaption class="gallery-caption"><span style="color: #F44336; background-color: rgba(244, 67, 54, 0.1);">an old gramophone</span> on <span style="color: #FF8F00; background-color: rgba(255, 193, 7, 0.1);">a windowsill</span> with <span style="color: #4CAF50; background-color: rgba(76, 175, 80, 0.1);">falling autumn leaves</span></figcaption>
    </figure>
</div>

The brighter regions in each visualization indicate where the lift scores are higher for that particular object or concept, showing how CompLift can identify the spatial location of each component in the prompt. Pixels with negative lift scores are masked and shown in black.

## üìä Correlation between Lift Scores and CLIP Scores

We investigate the empirical correlation between the lift scores and the CLIP scores of the generated images. Here we evaluate the CLIP scores and the number of activated pixels (pixels with positive lift scores) for each generated image with the prompt "a black car and a white clock".

<style>
.scatter-container {
  position: relative;
  margin: 20px auto;
  padding: 10px;
  border: 2px solid rgba(255,255,255,0.3);
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,248,255,0.95) 100%);
  border-radius: 10px;
  backdrop-filter: blur(10px);
  /* Mobile responsive styles */
  width: 100%;
  max-width: 820px;
  overflow-x: auto;
  box-sizing: border-box;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  .scatter-container {
    margin: 10px;
    padding: 5px;
    overflow-x: scroll;
    -webkit-overflow-scrolling: touch;
  }

  .scatter-plot {
    min-width: 600px; /* Minimum width to prevent cramping */
  }

  .axis-label {
    font-size: 12px !important;
  }

  .axis text {
    font-size: 10px !important;
  }
}

@media (max-width: 480px) {
  .scatter-container {
    margin: 5px;
    padding: 3px;
  }

  .scatter-plot {
    min-width: 500px;
  }

  .axis-label {
    font-size: 10px !important;
  }

  .axis text {
    font-size: 8px !important;
  }

  /* Smaller hover images on mobile */
  .image-overlay {
    width: 100px !important;
    height: 100px !important;
  }
}

.axis-label {
  font-family: 'Arial', sans-serif;
  font-size: 14px;
  font-weight: 600;
  fill: #2c3e50;
}

.axis path,
.axis line {
  stroke: #34495e;
  stroke-width: 2;
  shape-rendering: crispEdges;
}

.axis text {
  fill: #2c3e50;
  font-weight: 500;
}

.point {
  cursor: pointer;
}

.point-group {
  transition: all 0.3s ease-out;
  filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
}

.point {
  transition: all 0.3s ease-out;
}

.point-border {
  stroke-width: 3;
  fill: none;
  transition: all 0.3s ease-out;
  filter: drop-shadow(0 0 8px currentColor);
}

.image-overlay {
  position: absolute;
  pointer-events: none;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  border-radius: 50%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  transform-origin: center center;
}

.image-overlay.visible {
  opacity: 1;
}

.tooltip {
  position: absolute;
  padding: 15px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
  border: 2px solid rgba(59, 130, 246, 0.5);
  border-radius: 12px;
  pointer-events: none;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 100;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  max-width: 280px;
}

/* Mobile tooltip adjustments */
@media (max-width: 768px) {
  .tooltip {
    max-width: 200px;
    padding: 10px;
    font-size: 12px;
  }
}

@media (max-width: 480px) {
  .tooltip {
    max-width: 150px;
    padding: 8px;
    font-size: 10px;
  }
}

.tooltip img {
  width: 220px;
  height: 220px;
  object-fit: contain;
  display: block;
  margin-bottom: 8px;
  border-radius: 8px;
  border: 2px solid rgba(59, 130, 246, 0.3);
}

/* Mobile tooltip image adjustments */
@media (max-width: 768px) {
  .tooltip img {
    width: 150px;
    height: 150px;
  }
}

@media (max-width: 480px) {
  .tooltip img {
    width: 100px;
    height: 100px;
  }
}

.tooltip div {
  font-size: 13px;
  margin: 4px 0;
  text-align: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Mobile tooltip text adjustments */
@media (max-width: 768px) {
  .tooltip div {
    font-size: 11px;
    padding: 4px 8px;
  }
}

@media (max-width: 480px) {
  .tooltip div {
    font-size: 9px;
    padding: 3px 6px;
  }
}

/* Grid lines for better readability */
.grid line {
  stroke: rgba(52, 73, 94, 0.1);
  stroke-width: 1;
  shape-rendering: crispEdges;
}

.grid path {
  stroke-width: 0;
}
</style>

<div class="scatter-container">
  <svg class="scatter-plot"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="image-overlay-container"></div>
</div>

<!-- Mobile interaction hint -->
<div class="mobile-hint">
  <p><strong>üí° Mobile Tip:</strong> Tap any point to view the enlarged image. On mobile, you can scroll horizontally to see the full chart.</p>
</div>

<style>
.mobile-hint {
  display: none;
  text-align: center;
  margin: 10px auto;
  padding: 10px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  font-size: 14px;
  color: #374151;
  max-width: 600px;
}

@media (max-width: 768px) {
  .mobile-hint {
    display: block;
    font-size: 12px;
    margin: 5px;
    padding: 8px;
  }
}

@media (max-width: 480px) {
  .mobile-hint {
    font-size: 11px;
    padding: 6px;
  }
}
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {
  images: ['88.jpg', '35.jpg', '7.jpg', '87.jpg', '31.jpg', '46.jpg', '23.jpg', '21.jpg', '63.jpg', '14.jpg', '11.jpg', '22.jpg', '26.jpg', '16.jpg', '50.jpg', '4.jpg', '32.jpg', '59.jpg', '92.jpg', '24.jpg', '12.jpg', '18.jpg', '55.jpg', '60.jpg', '70.jpg', '80.jpg', '43.jpg', '57.jpg', '95.jpg', '56.jpg', '71.jpg', '79.jpg', '28.jpg', '90.jpg', '76.jpg', '94.jpg', '13.jpg', '15.jpg', '64.jpg', '77.jpg', '93.jpg', '61.jpg', '81.jpg', '25.jpg', '36.jpg', '84.jpg', '53.jpg', '67.jpg', '85.jpg', '20.jpg', '30.jpg', '48.jpg', '3.jpg', '19.jpg', '5.jpg', '1.jpg', '89.jpg', '58.jpg', '82.jpg', '66.jpg', '98.jpg', '8.jpg', '47.jpg', '65.jpg', '37.jpg', '33.jpg', '42.jpg', '40.jpg', '41.jpg', '86.jpg', '38.jpg', '74.jpg', '78.jpg', '91.jpg', '69.jpg', '2.jpg', '27.jpg', '72.jpg', '62.jpg', '73.jpg', '9.jpg', '6.jpg', '10.jpg', '0.jpg', '52.jpg', '96.jpg', '97.jpg', '39.jpg', '45.jpg', '68.jpg', '51.jpg', '75.jpg', '17.jpg'],
  clipScores: [0.2082290351390838, 0.2949512004852295, 0.2657198905944824, 0.2660695314407348, 0.2530303001403808, 0.2318295538425445, 0.2551944255828857, 0.2188099771738052, 0.1750942766666412, 0.2713091373443603, 0.2937318980693817, 0.265780508518219, 0.1947014331817627, 0.1975520253181457, 0.2133774906396865, 0.2024672031402588, 0.2555937170982361, 0.2589658200740814, 0.2226685732603073, 0.1990541517734527, 0.2009880542755127, 0.2267373353242874, 0.2683018445968628, 0.2158290147781372, 0.1944620758295059, 0.2793134748935699, 0.251570463180542, 0.1823183596134185, 0.2277110069990158, 0.2718529105186462, 0.291670024394989, 0.2543158531188965, 0.2475530952215194, 0.2996455132961273, 0.1895356774330139, 0.2617505490779876, 0.2404685020446777, 0.2660462856292724, 0.2602310180664062, 0.2819329500198364, 0.1705629974603653, 0.2513225078582763, 0.1969276815652847, 0.1969461441040039, 0.2454052567481994, 0.2611884772777557, 0.1960837095975875, 0.2979300022125244, 0.2539918720722198, 0.2535290122032165, 0.1857627779245376, 0.2713980674743652, 0.1906308233737945, 0.2046535015106201, 0.2049099802970886, 0.2565841972827911, 0.2644965946674347, 0.1875859797000885, 0.1800371408462524, 0.2340931445360183, 0.2940186858177185, 0.1918868571519851, 0.1842844784259796, 0.2144172042608261, 0.2099960744380951, 0.1845736354589462, 0.2939673960208893, 0.2667993903160095, 0.207839161157608, 0.2725541591644287, 0.2229276895523071, 0.2478901147842407, 0.2838332653045654, 0.2315225303173065, 0.2619037926197052, 0.2052745521068573, 0.2469722181558609, 0.2682026624679565, 0.2642577290534973, 0.2312282919883728, 0.2764683961868286, 0.1939019858837127, 0.2015535235404968, 0.1811759024858474, 0.2621297836303711, 0.208440363407135, 0.275995671749115, 0.220633178949356, 0.1831966340541839, 0.2715634703636169, 0.2046765089035034, 0.2397863119840622, 0.1808712482452392],
  activatedPixels: [246.0, 606.0, 204.0, 440.0, 69.0, 886.0, 327.0, 52.0, 19.0, 225.0, 1079.0, 451.0, 30.0, 23.0, 2.0, 234.0, 659.0, 867.0, 151.0, 34.0, 196.0, 9.0, 677.0, 9.0, 37.0, 994.0, 529.0, 19.0, 89.0, 660.0, 1127.0, 408.0, 232.0, 643.0, 34.0, 718.0, 468.0, 405.0, 770.0, 973.0, 31.0, 836.0, 27.0, 9.0, 654.0, 187.0, 27.0, 963.0, 444.0, 927.0, 15.0, 863.0, 39.0, 33.0, 20.0, 525.0, 270.0, 106.0, 41.0, 451.0, 1041.0, 2.0, 6.0, 149.0, 17.0, 75.0, 440.0, 168.0, 135.0, 740.0, 13.0, 182.0, 635.0, 397.0, 295.0, 93.0, 544.0, 483.0, 380.0, 16.0, 703.0, 4.0, 155.0, 3.0, 767.0, 40.0, 862.0, 115.0, 3.0, 779.0, 86.0, 713.0, 1.0]
};

function createScatterPlot() {
  // Clear any existing content
  d3.select('.scatter-plot').selectAll('*').remove();

  // Get container dimensions dynamically
  const container = document.querySelector('.scatter-container');
  const containerWidth = container.clientWidth;
  const isMobile = window.innerWidth <= 768;
  const isSmallMobile = window.innerWidth <= 480;

  // Set responsive dimensions
  let svgWidth, svgHeight;
  if (isSmallMobile) {
    svgWidth = Math.max(500, containerWidth - 20);
    svgHeight = 400;
  } else if (isMobile) {
    svgWidth = Math.max(600, containerWidth - 20);
    svgHeight = 450;
  } else {
    svgWidth = Math.min(800, containerWidth - 20);
    svgHeight = 500;
  }

  // Set up responsive margins
  const margin = isMobile ?
    { top: 30, right: 30, bottom: 50, left: 50 } :
    { top: 40, right: 40, bottom: 60, left: 60 };

  const width = svgWidth - margin.left - margin.right;
  const height = svgHeight - margin.top - margin.bottom;

  // Update SVG dimensions
  const svg = d3.select('.scatter-plot')
    .attr('width', svgWidth)
    .attr('height', svgHeight)
    .append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  // Create scales
  const x = d3.scaleLinear()
    .domain([-40, d3.max(data.activatedPixels)])
    .range([0, width]);

  const y = d3.scaleLinear()
    .domain([d3.min(data.clipScores)-0.01, 0.003+d3.max(data.clipScores)])
    .range([height, 0]);

  // Color scale for CLIP scores (from red to green)
  const colorScale = d3.scaleSequential(d3.interpolateViridis)
    .domain([d3.min(data.clipScores), d3.max(data.clipScores)]);

  // Add grid lines
  const xGrid = d3.axisBottom(x)
    .tickSize(-height)
    .tickFormat('')
    .tickValues(x.ticks().filter(d => d >= 0));

  const yGrid = d3.axisLeft(y)
    .tickSize(-width)
    .tickFormat('');

  svg.append('g')
    .attr('class', 'grid')
    .attr('transform', `translate(0,${height})`)
    .call(xGrid);

  svg.append('g')
    .attr('class', 'grid')
    .call(yGrid);

  // Create axes with responsive tick count
  const xAxis = d3.axisBottom(x)
    .tickValues(x.ticks(isMobile ? 5 : 8).filter(d => d >= 0));
  const yAxis = d3.axisLeft(y)
    .ticks(isMobile ? 5 : 8);

  // Add axes
  svg.append('g')
    .attr('class', 'x axis')
    .attr('transform', `translate(0,${height})`)
    .call(xAxis);

  svg.append('g')
    .attr('class', 'y axis')
    .call(yAxis);

  // Add axis labels with responsive positioning
  const xLabel = svg.append('text')
    .attr('class', 'axis-label')
    .attr('text-anchor', 'middle')
    .attr('x', width / 2)
    .attr('y', height + (isMobile ? 35 : 45));

  xLabel.append('tspan')
    .text('#Activated Pixels of ');

  xLabel.append('tspan')
    .style('font-style', 'italic')
    .text('A White Clock');

  const yLabel = svg.append('text')
    .attr('class', 'axis-label')
    .attr('text-anchor', 'middle')
    .attr('transform', 'rotate(-90)')
    .attr('x', -height / 2)
    .attr('y', -(isMobile ? 35 : 45));

  yLabel.append('tspan')
    .text('CLIP Score of ');

  yLabel.append('tspan')
    .style('font-style', 'italic')
    .text('A White Clock');

  // Responsive point sizes
  const pointRadius = isMobile ? 12 : 18;
  const pointImageSize = isMobile ? 20 : 30;
  const hoverAreaSize = isMobile ? 35 : 50;

  // Create points as images with colored borders
  const points = svg.selectAll('.point')
    .data(data.activatedPixels.map((d, i) => ({
      x: d,
      y: data.clipScores[i],
      image: data.images[i],
      index: i,
      color: colorScale(data.clipScores[i])
    })))
    .enter()
    .append('g')
    .attr('class', 'point-group')
    .attr('transform', d => `translate(${x(d.x)}, ${y(d.y)})`);

  // Add colored border circle
  points.append('circle')
    .attr('class', 'point-border')
    .attr('r', pointRadius)
    .attr('stroke', d => d.color)
    .attr('stroke-width', isMobile ? 2 : 3)
    .attr('fill', 'none');

  // Add invisible larger hover area
  points.append('rect')
    .attr('x', -hoverAreaSize/2)
    .attr('y', -hoverAreaSize/2)
    .attr('width', hoverAreaSize)
    .attr('height', hoverAreaSize)
    .style('fill', 'transparent')
    .style('cursor', 'pointer');

  // Add the actual image
  points.append('image')
    .attr('class', 'point')
    .attr('x', -pointImageSize/2)
    .attr('y', -pointImageSize/2)
    .attr('width', pointImageSize)
    .attr('height', pointImageSize)
    .attr('href', d => `./images/${d.image}`)
    .style('border-radius', '50%')
    .style('opacity', 0.95)
    .style('pointer-events', 'none')
    .attr('clip-path', `circle(${pointImageSize/2}px at ${pointImageSize/2}px ${pointImageSize/2}px)`);

  // Handle hover for image scaling with mobile optimization
  points.on('mouseover', function(event, d) {
    const pointGroup = d3.select(this);
    const border = pointGroup.select('.point-border');

    // Bring to front
    this.parentNode.appendChild(this);

    // Create HTML overlay for enlarged image
    const container = document.getElementById('image-overlay-container');
    const overlay = document.createElement('img');
    overlay.className = 'image-overlay';
    overlay.src = `./images/${d.image}`;

    // Responsive overlay size
    const overlaySize = isSmallMobile ? 100 : (isMobile ? 120 : 150);
    overlay.style.width = overlaySize + 'px';
    overlay.style.height = overlaySize + 'px';
    overlay.style.border = `${isMobile ? 3 : 4}px solid ${d.color}`;
    overlay.style.filter = `drop-shadow(0 0 ${isMobile ? 15 : 20}px ${d.color})`;

    // Position the overlay at the point location
    const pointX = x(d.x) + margin.left;
    const pointY = y(d.y) + margin.top;

    overlay.style.left = (pointX - overlaySize/2) + 'px';
    overlay.style.top = (pointY - overlaySize/2) + 'px';

    container.appendChild(overlay);

    // Trigger the animation
    setTimeout(() => {
      overlay.classList.add('visible');
    }, 10);

    // Animate border glow effect
    border.transition()
      .duration(300)
      .attr('stroke-width', isMobile ? 3 : 5)
      .style('filter', `drop-shadow(0 0 ${isMobile ? 10 : 15}px ${d.color})`);
  })
  .on('mouseout', function(event, d) {
    const border = d3.select(this).select('.point-border');

    // Remove HTML overlay
    const container = document.getElementById('image-overlay-container');
    const overlays = container.querySelectorAll('.image-overlay');
    overlays.forEach(overlay => {
      if (overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    });

    // Animate border back to normal
    border.transition()
      .duration(250)
      .attr('stroke-width', isMobile ? 2 : 3)
      .style('filter', 'none');
  })
  // Add touch events for mobile devices
  .on('touchstart', function(event, d) {
    event.preventDefault(); // Prevent default touch behavior

    const pointGroup = d3.select(this);
    const border = pointGroup.select('.point-border');

    // Bring to front
    this.parentNode.appendChild(this);

    // Create HTML overlay for enlarged image
    const container = document.getElementById('image-overlay-container');

    // Remove any existing overlays first
    const existingOverlays = container.querySelectorAll('.image-overlay');
    existingOverlays.forEach(overlay => {
      if (overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    });

    const overlay = document.createElement('img');
    overlay.className = 'image-overlay';
    overlay.src = `./images/${d.image}`;

    // Responsive overlay size for touch
    const overlaySize = isSmallMobile ? 120 : (isMobile ? 140 : 170);
    overlay.style.width = overlaySize + 'px';
    overlay.style.height = overlaySize + 'px';
    overlay.style.border = `${isMobile ? 3 : 4}px solid ${d.color}`;
    overlay.style.filter = `drop-shadow(0 0 ${isMobile ? 15 : 20}px ${d.color})`;

    // Position the overlay at the point location
    const pointX = x(d.x) + margin.left;
    const pointY = y(d.y) + margin.top;

    overlay.style.left = (pointX - overlaySize/2) + 'px';
    overlay.style.top = (pointY - overlaySize/2) + 'px';

    container.appendChild(overlay);

    // Trigger the animation
    setTimeout(() => {
      overlay.classList.add('visible');
    }, 10);

    // Animate border glow effect
    border.transition()
      .duration(300)
      .attr('stroke-width', isMobile ? 4 : 6)
      .style('filter', `drop-shadow(0 0 ${isMobile ? 12 : 18}px ${d.color})`);

    // Auto-hide after 3 seconds on mobile
    setTimeout(() => {
      const container = document.getElementById('image-overlay-container');
      const overlays = container.querySelectorAll('.image-overlay');
      overlays.forEach(overlay => {
        if (overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      });

      border.transition()
        .duration(250)
        .attr('stroke-width', isMobile ? 2 : 3)
        .style('filter', 'none');
    }, 3000);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  createScatterPlot();

  // Add resize listener for responsive behavior
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      createScatterPlot();
    }, 250);
  });
});
</script>

## üß∞ Get Started

Want to try it? Check out our [GitHub repo](https://github.com/rainorangelemon/complift-t2i)!

```bash
git clone https://github.com/rainorangelemon/complift-t2i
cd complift-t2i
python run_lift.py --prompt "a black car and a white clock"
```

## üß© Final Thoughts

CompLift shows how diffusion models can be made **compositional**‚Äîby introspecting their own denoising behavior. It's simple, elegant, and practical.

While we've focused on image generation, the principles behind lift scores may apply to **video, music, or even language generation** in the future.

## üìÑ Paper

> [Chenning Yu](https://rainorangelemon.github.io/) and [Sicun Gao](https://scungao.github.io/). *Improving Compositional Generation with Diffusion Models Using Lift Scores*. ICML 2025. [[ArXiv](https://arxiv.org/abs/2505.13740)] [[GitHub](https://github.com/rainorangelemon/complift)]
> ```bibtex
> @inproceedings{yu2025improving,
>  title={Improving Compositional Generation with Diffusion Models Using Lift Scores},
>  author={Yu, Chenning and Gao, Sicun},
>  booktitle={Proceedings of the 42nd International Conference on Machine Learning (ICML)},
>  year={2025}
> }
> ```

<!-- MathJax configuration for mobile responsiveness -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  svg: {
    fontCache: 'global',
    scale: 1,
    minScale: 0.5,
    matchFontHeight: false
  },
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      // Add mobile-specific handling after MathJax loads
      if (window.innerWidth <= 768) {
        setTimeout(function() {
          // Make equations scrollable on mobile
          const displays = document.querySelectorAll('mjx-container[display="true"]');
          displays.forEach(function(display) {
            display.style.overflowX = 'auto';
            display.style.overflowY = 'hidden';
            display.style.maxWidth = '100%';
            display.style.webkitOverflowScrolling = 'touch';
          });

          // Add scroll indicators for long equations
          const longEquations = Array.from(displays).filter(eq => eq.scrollWidth > eq.clientWidth);
          longEquations.forEach(function(eq) {
            if (!eq.querySelector('.scroll-hint')) {
              const hint = document.createElement('div');
              hint.className = 'scroll-hint';
              hint.textContent = '‚Üê scroll ‚Üí';
              hint.style.cssText = 'text-align: center; font-size: 0.7em; color: #666; margin-top: 5px; opacity: 0.7;';
              eq.parentNode.insertBefore(hint, eq.nextSibling);
            }
          });
        }, 1000);
      }
    }
  }
};
</script>